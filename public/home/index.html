<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard · GitHub Clone</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <style>
              /* Grass Styles */
              .graph-container {
                  padding: 24px;
                  background: #ffffff;
                  border: 1px solid #d0d7de;
                  border-radius: 6px;
                  margin-bottom: 24px;
                  overflow-x: auto;
                  display: flex;
                  flex-direction: column;
                  align-items: center; /* 가로 중앙 정렬 */
              }
              .weeks-container {
                  display: flex;
                  gap: 4px;
              }
              .week {
                  display: flex;
                  flex-direction: column;
                  gap: 4px;
              }
              .day {
                  width: 12px;
                  height: 12px;
                  border-radius: 2px;
                  background-color: #ebedf0;
              }      .day[data-level="1"] {
        background-color: #9be9a8;
      }
      .day[data-level="2"] {
        background-color: #40c463;
      }
      .day[data-level="3"] {
        background-color: #30a14e;
      }
      .day[data-level="4"] {
        background-color: #216e39;
      }

      .year-nav {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }
      .year-nav button {
        background: none;
        border: 1px solid #d0d7de;
        border-radius: 6px;
        padding: 3px 8px;
        cursor: pointer;
        font-size: 12px;
      }
      .year-nav button:hover {
        background-color: #f3f4f6;
      }

      #tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
        display: none;
        z-index: 1000;
      }
    </style>
  </head>
  <body>
    <div id="tooltip"></div>
    <div class="header">
      <a href="/home" class="header-logo">
        <svg
          height="32"
          viewBox="0 0 16 16"
          version="1.1"
          width="32"
          aria-hidden="true"
          fill="white"
        >
          <path
            fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"
          ></path>
        </svg>
        Dashboard
      </a>
      <div id="headerUser" class="header-user">Loading...</div>
    </div>

    <div class="container">
      <!-- Grass Section -->
      <h2 style="font-weight: 400; font-size: 16px; margin-bottom: 8px">
        Contributions
      </h2>
      <div class="year-nav">
        <button id="prevYearBtn">&lt;</button>
        <span
          id="currentYearDisplay"
          style="font-weight: 600; font-size: 14px"
        ></span>
        <button id="nextYearBtn">&gt;</button>
      </div>
      <div id="grassContainer" class="graph-container">
        <div style="text-align: center; padding: 20px; color: #57606a">
          Loading contributions...
        </div>
      </div>

      <h2
        style="
          font-weight: 400;
          font-size: 24px;
          margin-bottom: 16px;
          margin-top: 32px;
        "
      >
        Repositories
      </h2>
      <div id="loading" class="text-center">Loading repositories...</div>
      <ul id="repoList" class="repo-list"></ul>
    </div>

    <script src="/js/utils.js"></script>
    <script>
      requireAuth();
      renderHeader();

      let currentYear = new Date().getFullYear();
      document.getElementById("currentYearDisplay").innerText = currentYear;

      // Repositories Fetch
      const fetchRepos = async () => {
        try {
          const data = await fetchAPI(`${API_BASE}/test`);
          const repos = data.success.repos;
          renderRepos(repos);
        } catch (e) {
          document.getElementById("loading").innerHTML = `Error: ${e.message}`;
        }
      };

      const renderRepos = (repos) => {
        const list = document.getElementById("repoList");
        document.getElementById("loading").classList.add("d-none");

        list.innerHTML = repos
          .map(
            (repo) => `
                <li class="repo-item">
                    <div style="flex: 1;">
                        <div class="repo-name">
                            <a href="/repo?owner=${repo.owner.login}&repo=${
              repo.name
            }">${repo.owner.login} / ${repo.name}</a>
                            ${
                              repo.fork
                                ? `
                                <span class="badge badge-fork">
                                    <svg aria-hidden="true" height="12" viewBox="0 0 16 16" version="1.1" width="12" data-view-component="true">
                                        <path d="M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-.878A2.25 2.25 0 1 1 12.5 5a2.25 2.25 0 0 1-1.5 2.122v.878A2.25 2.25 0 0 1 8.75 10.25h-.75v.878A2.25 2.25 0 1 1 6.5 13a2.25 2.25 0 0 1-1.5-2.122v-.878A2.25 2.25 0 0 1 2.75 7.75v-.878A2.25 2.25 0 1 1 5 5.372ZM4.25 3a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm8.5 0a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM6.5 11.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Z"></path>
                                    </svg>
                                    Forked
                                </span>`
                                : ""
                            }
                            <span class="badge">
                                ${repo.private ? "Private" : "Public"}
                            </span>
                        </div>
                        <div class="repo-desc">${
                          repo.description || "No description provided."
                        }</div>
                        <div class="repo-meta">
                            ${
                              repo.language
                                ? `<span><span style="display:inline-block;width:10px;height:10px;background-color:#3178c6;border-radius:50%;margin-right:4px;"></span>${repo.language}</span>`
                                : ""
                            }
                            <span>Updated on ${timeAgo(repo.updated_at)}</span>
                        </div>
                    </div>
                    <div>
                        <button class="btn" onclick="location.href='/repo?owner=${
                          repo.owner.login
                        }&repo=${repo.name}'">View code</button>
                    </div>
                </li>
            `
          )
          .join("");
      };

      // Grass Fetch
      const fetchGrass = async (year) => {
        const container = document.getElementById("grassContainer");
        container.innerHTML =
          '<div style="text-align:center; padding: 20px; color:#57606a;">Loading contributions...</div>';

        try {
          const data = await fetchAPI(`${API_BASE}/test/grass`, { year });
          renderGrass(data);
        } catch (e) {
          container.innerHTML = `<div style="color:red; padding:10px;">Failed to load grass: ${e.message}</div>`;
        }
      };

      const renderGrass = (data) => {
        const container = document.getElementById("grassContainer");
        container.innerHTML = ""; // Clear loading

        const weeks =
          data?.success?.grass?.data?.user?.contributionsCollection
            ?.contributionCalendar?.weeks;
        if (!weeks) {
          container.innerHTML =
            '<div style="padding:10px;">No contribution data found.</div>';
          return;
        }

                    // Months Header Logic
                    const monthsHeader = document.createElement('div');
                    monthsHeader.className = 'months-header';
                    monthsHeader.style.display = 'flex';
                    monthsHeader.style.gap = '4px'; // weeks-container gap과 동일
                    monthsHeader.style.marginBottom = '8px';
                    monthsHeader.style.width = '100%'; // 컨테이너 너비 맞춤
                    monthsHeader.style.maxWidth = (weeks.length * 16) + 'px'; // 전체 주 개수 * (셀 너비 12 + 갭 4)
        
                    let lastMonth = -1;
        
                    weeks.forEach((week, index) => {
                        const firstDay = week.contributionDays[0];
                        const date = new Date(firstDay.date);
                        const currentMonth = date.getMonth();
        
                        const label = document.createElement('span');
                        label.style.fontSize = '12px';
                        label.style.color = '#57606a';
                        label.style.width = '12px'; // week 너비와 동일 (셀 12px)
                        label.style.textAlign = 'left';
                        label.style.overflow = 'visible'; // 텍스트가 칸을 넘어가도 보이게
                        label.style.whiteSpace = 'nowrap';
        
                        // 월이 바뀌거나 첫 번째 주인데 날짜가 10일 이내일 때 표시 (너무 끝에 12월이 찍히는 것 방지 등)
                        // 단순히 월이 바뀌는 시점에 표시
                        if (currentMonth !== lastMonth) {
                            const monthName = date.toLocaleString('en-US', { month: 'short' });
                            label.innerText = monthName;
                            lastMonth = currentMonth;
                        } else {
                            label.innerText = '';
                        }
                        
                        monthsHeader.appendChild(label);
                    });
                    container.appendChild(monthsHeader);
        
                    const gridContainer = document.createElement('div');        gridContainer.className = "weeks-container";

        weeks.forEach((week) => {
          const weekDiv = document.createElement("div");
          weekDiv.className = "week";

          // 첫 번째 날짜의 요일 확인 (0: 일요일 ~ 6: 토요일)
          const firstDay = week.contributionDays[0];
          const firstWeekday = new Date(firstDay.date).getDay(); // API에 weekday가 없을 수 있으므로 날짜로 계산

          // 만약 첫 날이 일요일(0)이 아니라면, 그만큼 빈 칸(투명 div) 추가
          for (let i = 0; i < firstWeekday; i++) {
            const emptyDay = document.createElement("div");
            emptyDay.className = "day";
            emptyDay.style.backgroundColor = "transparent";
            weekDiv.appendChild(emptyDay);
          }

          week.contributionDays.forEach((day) => {
            const dayDiv = document.createElement("div");
            dayDiv.className = "day";

            let level = 0;
            if (day.contributionCount > 0) level = 1;
            if (day.contributionCount > 3) level = 2;
            if (day.contributionCount > 6) level = 3;
            if (day.contributionCount > 10) level = 4;

            dayDiv.setAttribute("data-level", level);

            // Tooltip Events
            dayDiv.addEventListener("mouseover", (e) => {
              const tooltip = document.getElementById("tooltip");
              tooltip.innerText = `${day.contributionCount} contributions on ${day.date}`;
              tooltip.style.display = "block";
              tooltip.style.left = e.pageX + 10 + "px";
              tooltip.style.top = e.pageY - 30 + "px";
            });
            dayDiv.addEventListener("mouseout", () => {
              document.getElementById("tooltip").style.display = "none";
            });

            weekDiv.appendChild(dayDiv);
          });
          gridContainer.appendChild(weekDiv);
        });
        container.appendChild(gridContainer);
      };

      // Year Navigation Events
      document.getElementById("prevYearBtn").addEventListener("click", () => {
        currentYear--;
        document.getElementById("currentYearDisplay").innerText = currentYear;
        fetchGrass(currentYear);
      });
      document.getElementById("nextYearBtn").addEventListener("click", () => {
        currentYear++;
        document.getElementById("currentYearDisplay").innerText = currentYear;
        fetchGrass(currentYear);
      });

      fetchRepos();
      fetchGrass(currentYear);
    </script>
  </body>
</html>
